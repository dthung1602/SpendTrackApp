$(document).ready(function(){$("#edit-account-button").click(editAccount);$("#delete-account-button").click(deleteAccountForm);$("#save-account-button").click(submitEditAccountForm).hide();$("#cancel-edit-account-button").click(cancelEditAccount).hide();$("#change-password-button").click(submitChangePasswordForm);$(".input-error").hide();$("#password-change-success").hide();$("#account-change-success").hide()});class Account{constructor(data){this.username=data.username;this.email=data.email;this.first_name=data.first_name;this.last_name=data.last_name;this.errors={};this.clean()}clean(){const usernameRegex=/^[a-zA-Z0-9_@+.\-]{1,150}$/;if(!this.username.match(usernameRegex))this.addError("username","Usernames must be from 1 to 150 characters long and can only contain alphanumeric, _, @, +, . and - characters.");if(this.first_name.length>30)this.addError("first_name","First names are as most 30 characters long.");if(this.last_name.length>150)this.addError("last_name","last names are as most 30 characters long.");const emailRegex=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if(this.email.length>0&&!this.email.match(emailRegex))this.addError("email","Invalid email")}addError(field,errorMessage){if(this.errors[field]===undefined)this.errors[field]=[errorMessage];else this.errors[field].push(errorMessage)}isValid(){return isEmpty(this.errors)}getSubmitData(){let object={csrfmiddlewaretoken:$('[name="csrfmiddlewaretoken"]').val()};for(let i=0;i<this.fields.length;i++){let field=this.fields[i];object[field]=this[field]}return object}}Account.fields=["username","email","first_name","last_name"];function editAccount(){let rootNode=$(".account table");storeData("account",0,rootNode.html());let tds=["username","email","first_name","last_name"];for(let i=0;i<tds.length;i++){let td=$("#td_"+tds[i]);let inputField=$('<input type="text" id="account_'+tds[i]+'">').val(td.html());td.html("").append(inputField).append($('<div class="input-error" id="error_'+tds[i]+'">').hide())}$("#edit-account-button").hide();$("#delete-account-button").hide();$("#save-account-button").show();$("#cancel-edit-account-button").show()}function cancelEditAccount(){$(".account table").html(retrieveData("account",0));$("#edit-account-button").show();$("#delete-account-button").show();$("#save-account-button").hide();$("#cancel-edit-account-button").hide()}function getAccountInfo(){let data={};let fields=Account.fields;for(let i=0;i<fields.length;i++){data[fields[i]]=$("#account_"+fields[i]).val()}return data}function editAccountSuccessFunc(account){return function(){cancelEditAccount();enableSaveAccountButton();let fields=["username","email","first_name","last_name"];for(let i=0;i<fields.length;i++){$("#td_"+fields[i]).html(account[fields[i]])}$("#account-change-success").show().text("Account updated successfully at "+new Date)}}function editAccountFailFunc(){return function(response,status,error){enableSaveAccountButton();displayError(response,status,error)}}function submitEditAccountForm(){let account=new Account(getAccountInfo());if(account.isValid()){disableSaveAccountButton();$.ajax({url:"/account/edit/",type:"POST",dataType:"json",data:account.getSubmitData(),success:editAccountSuccessFunc(account),error:editAccountFailFunc()});$(".input-error").hide()}else{for(let i=0;i<Account.fields.length;i++){let f=Account.fields[i];if(account.errors.hasOwnProperty(f))$("#error_"+f).show().html(account.errors[f].join("<br>"))}}}function disableSaveAccountButton(){$("#save-account-button").html("SAVING...").addClass("disable").off("click")}function enableSaveAccountButton(){$("#save-account-button").html("SAVE").removeClass("disable").click(submitEditAccountForm)}function deleteAccountForm(){if(!confirm("Are you sure to delete this account?"))return;if(!confirm("Are you REALLY sure?"))return;if(!confirm("Are you REALLY REALLY sure?"))return;$.ajax({url:"/account/delete/",type:"POST",dataType:"json",data:{csrfmiddlewaretoken:$('[name="csrfmiddlewaretoken"]').val()},success:deleteAccountSuccess,error:displayError})}function deleteAccountSuccess(){deleteAllCookies();window.location.replace("/")}
