const ENTRY_CAT_FIELD_ID="entry-category";const ENTRY_DATE_FORMAT="E NNN dd, hh a";$(document).ready(function(){$("#submit-entry-button").click(submitNewEntryForm);startTime();if($(".no-data").length===0)viewTablePage(1);$("#category-dropdown-container").html(Category.toDropdownMenu(ENTRY_CAT_FIELD_ID,false));Category.clearSelectCategoryField(ENTRY_CAT_FIELD_ID)});function startTime(){let now=new Date;$("#clock").html("").append($("<div>").html(now.format("EE dd/MM/yyyy"))).append($("<div>").html(now.format("HH:mm:ss")));setTimeout(startTime,1e3)}class Entry{constructor(data){this.id=data.id;this.date=data.date;this.content=data.content;this.leaf_category=data.leaf_category;this.value=data.value;this.errors={};this.clean()}addError(field,errorMessage){if(this.errors[field]===undefined)this.errors[field]=[errorMessage];else this.errors[field].push(errorMessage)}isValid(){return isEmpty(this.errors)}clean(){let d=Date.parse(this.date);if(isNaN(d))this.addError("date","Invalid date format");else this.date=new Date(d);this.content=this.content.trim();if(this.content.length===0)this.addError("content","Content cannot be empty");if(this.content.length>200)this.addError("content","Content is too long");if(this.leaf_category==="empty"||categoryHiddenData.id.indexOf(this.leaf_category)===-1)this.addError("leaf_category","Invalid category id");try{if(!this.value.match(/^[0-9 +\-*\/().]+$/)){throw""}this.value=parseFloat(eval(this.value).toFixed(2))}catch(err){this.addError("value","Invalid arithmetic expression")}}getSubmitData(){let object={csrfmiddlewaretoken:$('[name="csrfmiddlewaretoken"]').val(),id:this.id};for(let i=0;i<Entry.fields.length;i++){let field=Entry.fields[i];object[field]=this[field]}object.date=this.date.format("yyyy-MM-dd HH:mm:ss");return object}getCategoryName(){return categoryHiddenData.name[categoryHiddenData.id.indexOf(this.leaf_category)]}getDescription(){return"["+this.date.toISODateString()+"] "+this.content}toRow(){const prefix="entry-"+this.id+"-";let pageCount=Math.max($(".page-control div").length,1);let row=$("<tr>").attr("id","entry-row-"+this.id).addClass("table-page-"+pageCount);$('<td id="'+prefix+'date">').text(this.date.format(ENTRY_DATE_FORMAT)).appendTo(row);$('<td id="'+prefix+'content">').text(this.content).appendTo(row);$('<td id="'+prefix+'value" class="align-right">').text(this.value.toFixed(2)).appendTo(row);$('<td id="'+prefix+'category" class="align-right">').text(this.getCategoryName()).appendTo(row);$('<td class="entry-edit">').appendTo(row).append($('<img src="/static/spendtrackapp/img/edit-icon.png" alt="edit" onclick="editEntry('+this.id+')">'));if(pageCount>1){let visible=$(".table-page-"+pageCount).is(":visible");if(!visible)row.hide()}return row}}Entry.fields=["date","content","leaf_category","value"];function clearNewEntryFields(){$("#new-entry [id^=entry]").val("");Category.clearSelectCategoryField(ENTRY_CAT_FIELD_ID);$("#new-entry .input-error").hide()}function getNewEntryData(){return{csrfmiddlewaretoken:$('[name="csrfmiddlewaretoken"]').val(),date:$("#entry-date").val().replace("T"," "),content:$("#entry-content").val().trim(),leaf_category:$("#entry-category").val(),value:$("#entry-value").val()}}function addNewEntryFail(response,status,error){enableAddEntryButton();switch(error){case"Bad Request":let fields=["date","content","leaf_category","value"];let causes=[];for(let i=0;i<fields.length;i++){let f=fields[i];if(response["responseJSON"].hasOwnProperty(f)){let r=response["responseJSON"][f];for(let j=0;j<r.length;j++){causes.push(f+": "+r[j])}}}alert("Bad request:\n- "+causes.join("\n- "));break;case"Internal Server Error":alert("Internal Server Error\nPlease try again later");break;default:alert("Unknown error\nPlease try again later")}}function addNewEntrySuccessFuncGenerator(entry){return function(response){entry.id=response.id;let totalInWeek=$("#total-in-week");let totalInMonth=$("#total-in-month");let now=new Date;let submitDate=new Date(entry.date);let wn=submitDate.getWeekNumber();let m=submitDate.getMonth();let y=submitDate.getFullYear();$("#new-entry-success-panel").show().html("Item added to week "+wn+" of year "+y);if(now.getWeekNumber()===wn||now.getFullYear()===y){$("#entry-container").append(entry.toRow());totalInWeek.text((parseFloat(totalInWeek.text())+entry.value).toFixed(2))}if(now.getMonth()===m&&now.getFullYear()===y)totalInMonth.text((parseFloat(totalInMonth.text())+entry.value).toFixed(2));$("#entry-container .no-data").remove();clearNewEntryFields();enableAddEntryButton()}}function submitNewEntryForm(){let entry=new Entry(getNewEntryData());$("#new-entry .input-error").hide();if(entry.isValid()){disableAddEntryButton();$.ajax({url:"/entry/add/",type:"POST",dataType:"json",data:entry.getSubmitData(),success:addNewEntrySuccessFuncGenerator(entry),error:addNewEntryFail})}else{for(let i=0;i<Entry.fields.length;i++){let field=Entry.fields[i];if(entry.errors.hasOwnProperty(field)){let errorHTML=entry.errors[field].join("<br>");$("#entry-"+field.replace("_","-")+"-error").html(errorHTML).show()}}}}function disableAddEntryButton(){$("#submit-entry-button").html("ADDING...").addClass("disable").off("click")}function enableAddEntryButton(){$("#submit-entry-button").html("ADD").removeClass("disable").click(submitNewEntryForm)}function getEditEntryData(entryId){const prefix="#edit-entry-"+entryId+"-";return{id:entryId,date:$(prefix+"date").val(),content:$(prefix+"content").val(),value:$(prefix+"value").val(),leaf_category:$(prefix+"category").val()}}function addToElement(selector,value){let element=$(selector);element.text((parseFloat(element.text())+value).toFixed(2))}function getEntryOldValue(entryId){return parseFloat($("<div>").html(retrieveData("entry",entryId)).find("#entry-"+entryId+"-value").text())}function editEntrySuccessFunc(entry){return function(){$("#entry-row-"+entry.id).removeClass("editing").html(entry.toRow().html());const diff=entry.value-getEntryOldValue(entry.id);addToElement("#total-in-week",diff);addToElement("#total-in-month",diff)}}function saveEntryFuncGenerator(entryId){return function(){let entry=new Entry(getEditEntryData(entryId));if(entry.isValid()){$.ajax({url:"/entry/edit/",type:"POST",dataType:"json",data:entry.getSubmitData(),success:editEntrySuccessFunc(entry),error:displayError})}else{for(let i=0;i<Entry.fields.length;i++){let f=Entry.fields[i];if(entry.errors.hasOwnProperty(f)){$("#edit-entry-"+entryId+"-"+f).parent().find(".input-error").html(entry.errors[f].join("<br>")).show()}}}}}function deleteEntryFuncGenerator(entryId){return function(){if(!confirm("Are you sure to delete this entry?"))return;let data={csrfmiddlewaretoken:$('[name="csrfmiddlewaretoken"]').val(),id:entryId};$.ajax({url:"/entry/delete/",type:"POST",dataType:"json",data:data,success:()=>{$("#entry-row-"+entryId).remove();let diff=-getEntryOldValue(entryId);addToElement("#total-in-week",diff);addToElement("#total-in-month",diff);setTimeout(()=>{alert("Entry deleted successfully!")},750)},error:displayError})}}function cancelEditEntry(entryId){$("#entry-row-"+entryId).removeClass("editing").html(retrieveData("entry",entryId))}function editEntry(entryId){let row=$("#entry-row-"+entryId).addClass("editing");const idPrefix="entry-"+entryId+"-";const selectorPrefix="#"+idPrefix;storeData("entry",entryId,row.html());let dateValue=Date.parseString($(selectorPrefix+"date").text(),ENTRY_DATE_FORMAT);let content=$(selectorPrefix+"content").text();let value=$(selectorPrefix+"value").text();let categoryName=$(selectorPrefix+"category").text();let categoryId=categoryHiddenData.id[categoryHiddenData.name.indexOf(categoryName)];let categoryData={id:categoryId,name:categoryName};let dateFieldId="edit-"+idPrefix+"date";let categoryFieldId="edit-"+idPrefix+"category";let contentFieldId="edit-"+idPrefix+"content";let valueFieldId="edit-"+idPrefix+"value";row.html('<td colspan="5">'+'    <div class="row">'+'        <div class="six columns">'+'            <input type="datetime-local" id="'+dateFieldId+'" placeholder="yyyy-mm-dd hh:mm" autocomplete="off">'+"            <button>NOW</button>"+'            <div class="input-error"></div>'+"        </div>"+'        <div class="six columns">'+'            <input type="text" id="'+contentFieldId+'" placeholder="A carrot and an apple" maxlength="200">'+'            <div class="input-error"></div>'+"        </div>"+"    </div>"+'    <div class="row">'+'        <div class="six columns">'+'            <div id="'+categoryFieldId+'"></div>'+'            <div class="input-error"></div>'+"        </div>"+'        <div class="six columns">'+'            <input type="text" id="'+valueFieldId+'" placeholder="1.25 + 2.3 * 5" '+'                   pattern="^[0-9 \\+\\-\\*\\/\\(\\)\\.]+$">'+'            <div class="input-error"></div>'+"        </div>"+"    </div>"+'    <div class="row submit-row align-right">'+'        <button class="button-primary">SAVE</button>'+"        <button>CANCEL</button>"+'        <button class="button-danger">DELETE</button>'+"    </div>"+"</td>");row.find(".input-error").hide();setDateTime("#"+dateFieldId,dateValue);$("#"+contentFieldId).val(content);$("#"+valueFieldId).val(value);$("#"+categoryFieldId).html(Category.toDropdownMenu(categoryFieldId,false));Category.generateSelectCategoryFunc(categoryFieldId,categoryData)();row.find('button:contains("SAVE")').click(saveEntryFuncGenerator(entryId));row.find('button:contains("DELETE")').click(deleteEntryFuncGenerator(entryId));row.find('button:contains("NOW")').click(()=>{setDateTime("#"+dateFieldId)});row.find('button:contains("CANCEL")').click(()=>{cancelEditEntry(entryId)})}
